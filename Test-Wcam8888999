# Working Webcam Viewer for PowerShell
# Uses AVICAP32.DLL (built into Windows)

Add-Type -AssemblyName System.Windows.Forms
Add-Type -AssemblyName System.Drawing

# Define the webcam capture wrapper
Add-Type -TypeDefinition @"
using System;
using System.Runtime.InteropServices;

public class WebcamCapture {
    [DllImport("avicap32.dll", EntryPoint="capCreateCaptureWindowA")]
    public static extern IntPtr capCreateCaptureWindowA(
        string lpszWindowName, int dwStyle, int x, int y, 
        int nWidth, int nHeight, IntPtr hwndParent, int nID);
    
    [DllImport("user32.dll")]
    public static extern bool SendMessage(IntPtr hWnd, uint Msg, IntPtr wParam, IntPtr lParam);
    
    public const int WM_CAP_START = 0x400;
    public const int WM_CAP_DRIVER_CONNECT = WM_CAP_START + 10;
    public const int WM_CAP_DRIVER_DISCONNECT = WM_CAP_START + 11;
    public const int WM_CAP_SET_PREVIEW = WM_CAP_START + 50;
    public const int WM_CAP_SET_PREVIEWRATE = WM_CAP_START + 52;
    public const int WM_CAP_SET_SCALE = WM_CAP_START + 53;
    public const int WS_CHILD = 0x40000000;
    public const int WS_VISIBLE = 0x10000000;
}
"@ -ReferencedAssemblies @("System.Drawing") -ErrorAction Stop

# Check for webcam using WMI
$cameraDevices = Get-WmiObject Win32_PnPEntity | Where-Object {
    ($_.PNPClass -eq 'Camera' -or $_.Name -match 'camera|webcam') -and $_.Status -eq 'OK'
}

if (-not $cameraDevices -or $cameraDevices.Count -eq 0) {
    [System.Windows.Forms.MessageBox]::Show(
        "No webcam found or accessible.",
        "Error",
        [System.Windows.Forms.MessageBoxButtons]::OK,
        [System.Windows.Forms.MessageBoxIcon]::Error
    )
    exit
}

# Create main form
$form = New-Object System.Windows.Forms.Form
$form.Text = "Webcam Viewer"
$form.Size = New-Object System.Drawing.Size(660, 520)
$form.StartPosition = 'CenterScreen'
$form.BackColor = [System.Drawing.Color]::Black
$form.FormBorderStyle = 'FixedSingle'
$form.MaximizeBox = $false

# Create panel for video preview
$videoPanel = New-Object System.Windows.Forms.Panel
$videoPanel.Location = New-Object System.Drawing.Point(10, 50)
$videoPanel.Size = New-Object System.Drawing.Size(640, 480)
$videoPanel.BackColor = [System.Drawing.Color]::Black
$form.Controls.Add($videoPanel)

# Status label
$statusLabel = New-Object System.Windows.Forms.Label
$statusLabel.Text = "Initializing webcam..."
$statusLabel.ForeColor = [System.Drawing.Color]::White
$statusLabel.BackColor = [System.Drawing.Color]::Black
$statusLabel.Location = New-Object System.Drawing.Point(10, 10)
$statusLabel.Size = New-Object System.Drawing.Size(640, 30)
$statusLabel.Font = New-Object System.Drawing.Font("Segoe UI", 11, [System.Drawing.FontStyle]::Bold)
$statusLabel.TextAlign = 'MiddleCenter'
$form.Controls.Add($statusLabel)

# Global variable to store capture handle
$script:captureHandle = [IntPtr]::Zero

# Form shown event - initialize webcam
$form.Add_Shown({
    try {
        # Create capture window
        $hWnd = [WebcamCapture]::capCreateCaptureWindowA(
            "WebcamCapture", 
            [WebcamCapture]::WS_CHILD -bor [WebcamCapture]::WS_VISIBLE,
            0, 0, 640, 480, 
            $videoPanel.Handle, 
            0
        )
        
        if ($hWnd -eq [IntPtr]::Zero) {
            $statusLabel.Text = "Failed to create capture window"
            $statusLabel.ForeColor = [System.Drawing.Color]::Red
            return
        }
        
        $script:captureHandle = $hWnd
        $statusLabel.Text = "Connecting to webcam..."
        $form.Refresh()
        
        Start-Sleep -Milliseconds 100
        
        # Connect to first webcam (device index 0)
        $result = [WebcamCapture]::SendMessage($hWnd, [WebcamCapture]::WM_CAP_DRIVER_CONNECT, [IntPtr]0, [IntPtr]0)
        
        if (-not $result) {
            $statusLabel.Text = "Failed to connect to webcam - Try running as administrator"
            $statusLabel.ForeColor = [System.Drawing.Color]::Yellow
            return
        }
        
        # Configure preview
        [void][WebcamCapture]::SendMessage($hWnd, [WebcamCapture]::WM_CAP_SET_SCALE, [IntPtr]1, [IntPtr]0)
        [void][WebcamCapture]::SendMessage($hWnd, [WebcamCapture]::WM_CAP_SET_PREVIEWRATE, [IntPtr]66, [IntPtr]0)
        [void][WebcamCapture]::SendMessage($hWnd, [WebcamCapture]::WM_CAP_SET_PREVIEW, [IntPtr]1, [IntPtr]0)
        
        $statusLabel.Text = "Webcam Active - Press ESC or close window to exit"
        $statusLabel.ForeColor = [System.Drawing.Color]::LimeGreen
        
    } catch {
        $statusLabel.Text = "Error: $($_.Exception.Message)"
        $statusLabel.ForeColor = [System.Drawing.Color]::Red
    }
})

# Form closing event - cleanup
$form.Add_FormClosing({
    if ($script:captureHandle -ne [IntPtr]::Zero) {
        try {
            [void][WebcamCapture]::SendMessage(
                $script:captureHandle, 
                [WebcamCapture]::WM_CAP_DRIVER_DISCONNECT, 
                [IntPtr]0, 
                [IntPtr]0
            )
        } catch {
            # Ignore cleanup errors
        }
    }
})

# ESC key to close
$form.Add_KeyDown({
    if ($_.KeyCode -eq 'Escape') {
        $form.Close()
    }
})

# Show form
[System.Windows.Forms.Application]::Run($form)
